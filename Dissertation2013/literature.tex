\chapter{Обзор литературы} \label{chaptL}

Данная глава посвящена обзору литературы в области распознавания аккордов.
Область исследований достаточно молодая, поэтому практически все рассматриваемые
работы были опубликованы в последние 15 лет, а наиболее значимые результаты
были получены в течение последних 5 лет.

Предварительная обработка звукозаписи (параграф \ref{sectL_prelim}) так или
иначе присутствует практически во всех алгоритмах распознавания аккордов. Она
используется для уменьшения объёма вычислений на последующих этапах, а также
для более точной настройки алгоритма на конкретную звукозапись. Первым шагом к
непосредственному распознаванию аккордов является получение спектрограммы
(параграф \ref{sectL_spect}). В зависимости от наличия или отсутствия
предварительной обработки, а также используемого метода для вычисления спектра,
к ней применяются те или иные преобразования (параграф \ref{sectL_feat}).
Конечным итогом всех преобразований является представление спектрограммы в виде
последовательности векторов признаков, различные типы которых также описаны в
этом параграфе. Наконец, параграф \ref{sectL_post} описывает часто применяемые
методы классификации, позволяющие получить последовательность названий аккордов
из последовательности векторов признаков.

\section{Предварительная обработка} \label{sectL_prelim}

На этом этапе собирается информация, которая будет использоваться для получения
частотно-временного представления звукозаписи: определяются моменты начала
метрических долей и частота настройки музыкальных инструментов. Иногда
дополнительно производится разделение звука на гармонические и перкуссионные
компоненты, после чего последние удаляются из сигнала. К этому же этапу можно
отнести понижение частоты дискретизации цифровой звукозаписи для ускорения
вычислений на следующем этапе и преобразование стереофонических записей в
монофонические.

Понижение частоты дискретизации применяется во многих работах
(\cite{Sheh2003}, \cite{Bello2005}, \cite{Lee2006}, \cite{Burgoyne2007},
\cite{Lee2007}, \cite{Papadopoulos2007}, \cite{Mauch2008},
\cite{Khadkevich2009}, \cite{Mauch2009}, \cite{Oudre2009}, \cite{Reed2009},
\cite{Mauch2010}, \cite{Khadkevich2011}, \cite{Ni2011}, \cite{Humphrey2012})
для ускорения обработки файла. Как правило, частота дискретизации понижается со
стандартной для компакт-дисков 44100 Гц до 11025 Гц путем замены каждых 4 подряд
идущих отсчётов $x_Q(t_i), x_Q(t_{i+1}), x_Q(t_{i+2}), x_Q(t_{i+3})$ на
$x_Q(t_i)$. При этом терятся информация о частотах выше 5.5 кГц. Такая потеря
не является критичной, поскольку на частотах свыше 5 кГц человеческое
восприятие высоты тона существенно изменяется, в частности, нарушается октавное
сходство при удвоении частоты звука. Поэтому в музыке большая часть информации
находится на частотах до 5 кГц и остаётся незатронутой при таком понижении
частоты дискретизации.

Такое преобразование позволяет использовать меньший размер окна при вычислении
быстрого преобразования Фурье. Но при отсутствии жестких ограничений на
производительность понижение частоты дискретизации не является обязательным. В
\cite{Zhang2008}, \cite{Cho2010}, \cite{Rocher2010}, \cite{Cho2011},
\cite{DeHaas2012} частота дискретизации звукозаписей не меняется.

Общепринятым является преобразование стерофонических звукозаписей в
монофонические путём взятия среднего арифметического от сигналов левого и
правого каналов. При этом предполагается, что в них не будут звучать разные
аккорды, что, скорее всего, звучало бы неприятно для человека.

Определение моментов начала метрических долей позволяет на следующем шаге
получить спектрограмму, соотносящуюся с ритмом композиции. Смена аккорда, как и
любое другое событие в музыке, очень часто подчинена ритму и происходит на
границе метрических долей. Кроме того, в столбцах спектрограммы, соответствующих
акцентированным долям, будет более ярко выражено звучание инструментов и
соответствующие им пики спектра. Моменты начала метрических долей используются
как для деления звука на фрагменты, каждый из которых соответствует одной доле
или её части (\cite{Yoshioka2004}, \cite{Sumi2008}, \cite{Weller2009},
\cite{Mcvicar2011}, \cite{Ni2011}), так и для усреднения столбцов спектрограммы,
вычисленной с фиксированным шагом по времени, в пределах одной метрической доли
(\cite{Bello2005}, \cite{Mauch2009}, \cite{Mauch2010}, \cite{DeHaas2012},
\cite{Chen2012}. В \cite{Chen2012}, помимо описанных вариантов, также
применялась медианная фильтрация по всем столбцам спектрограммы в пределах одной
метрической доли, показавшая лучший результат.

Задача определения моментов начала метрических долей обычно формулируется в
рамках музыкального информационного поиска как задача отслеживания ритма (beat
detection). Новые алгоритмы для её решения появляются каждый год, но в методах
распознавания аккордов обычно применяется один из алгоритмов, представленных в
\cite{Davies2007}, \cite{Dixon2007}, \cite{Ellis2007}. Соответствующие
программные модули для этих алгоритмов доступны бесплатно и удобны в
подключении, что, по-видимому, является основной причиной их популярности.

Отклонение частоты настройки музыкальных инструментов от стандартного значения
440 Гц может как явно определяться на этапе предварительной обработки
(\cite{Gomez2006}, \cite{Papadopoulos2007}, \cite{Khadkevich2009},
\cite{Khadkevich2011}, \cite{Ni2011}, \cite{Jiang2011}, так и неявно учитываться
в процессе обработки спектрограммы (\cite{Bello2005}, \cite{Lee2006},
\cite{Reed2009}, \cite{Mauch2010}, \cite{Rocher2010}). Особенно важно учитывать
это отклонение при использовании преобразования постоянного качества (см.
параграф \ref{sectL_spect}), использующего заранее заданные частоты для
вычисления спектральных компонент. Некоторые алгоритмы для определения частоты
настройки представлены в работах \cite{Harte2005}, \cite{Zhu2005},
\cite{Gomez2006}, \cite{Peeters2006}, \cite{KhadkevichPhase2009}.

Разделение звука на гармонические и перкуссионные компоненты позволяет ослабить
влияние музыкальных инструментов с неясной высотой звучания на спектрограмму,
получаемую на следующем этапе. Аналогичные преобразования делаются на этапе
преобразования спектрограммы в последовательность векторов признаков во многих
работах. Но в \cite{Reed2009} и \cite{Ni2011} перкуссионные компоненты удаляются
из сигнала до построения спектрограммы при помощи свободно доступной для
научного использования реализации алгоритма \cite{Ono2008}.

\section{Спектрограмма} \label{sectL_spect}

Переход к частотно-временному представлению звукозаписи в виде спектрограммы
является ключевым, поскольку даёт возможность работать с отдельными частотными
компонентами звука. Как было отмечено выше, для этого звукозапись делится на
короткие, возможно, пересекающиеся фрагменты, на каждом из которых вычисляется
спектр звука.

В алгоритмах распознавания аккордов используются следующие методы получения
спектра.
\begin{enumerate}
  \item Дискретное оконное преобразование Фурье.
  $$X[n] = \sum_{j=0}^{J-1} w(j)x_Q(t_j) e^{-\frac{i 2\pi nj}{J}}, \quad n=0, 1,
  \ldots, N-1$$
  Здесь $J$ -- размер анализируемого фрагмента звукозаписи в отсчётах, $w(j)$ --
  функция, отличная от нуля на некотором промежутке, не выходящем за пределы
  этого фрагмента -- оконная функция. Прямоугольная оконная функция $w(j)$,
  равная 1 только на анализируемом фрагменте и 0 -- вне его, получается
  автоматически при разделении на фрагменты исходной звукозаписи. Среди других
  оконных функций наиболее популярной является окно Хемминга:
  $$w(j) = 0.53836 - 0.46164 \cos \left( \frac{2\pi j}{J-1} \right)$$
  При использовании оконной функции результатом преобразования Фурье является не
  спектр исходного сигнала, а спектр его произведения с оконной функцией.  
  Согласно свойству преобразования Фурье, этот спектр будет равен свёртке
  спектров исходного сигнала и оконной функции. Её выбор влияет на форму
  полученных искажений спектра. Более подробную информацию об эффектах от выбора
  оконной функции можно найти в \cite{Oppenheim2006}, раздел 10.3.1.
  
  Достоинствами дискретного оконного преобразования Фурье являются существование
  быстрых алгоритмов вычисления в определённых случаях и наличие большого
  количества реализаций на разных языках программирования. Вместе с тем, при
  использовании алгоритмов быстрого преобразования Фурье невозможно произвольным
  образом выбирать частоты его компонент. Это создает неудобства при дальнейшей
  обработке, поскольку невозможно точно определить количество звуковой энергии,
  приходящейся на частоты, соответствующие ступеням звукоряда. Дискретное
  оконное преобразование Фурье используется в \cite{Sheh2003},
  \cite{Gomez2006}, \cite{Burgoyne2007}, \cite{Papadopoulos2007},
  \cite{Khadkevich2009}, \cite{Weller2009}, \cite{Mauch2010},
  \cite{Khadkevich2011}, \cite{DeHaas2012}.
  
  \item Преобразование постоянного качества (constant Q преобразование).
  $$X[n] = \frac{1}{J(n)} \sum_{j=0}^{J(n)-1} w(n,j)x_Q(t_j) e^{-\frac{i 2\pi
  nj}{J(n)}}, \quad n=0, 1, \ldots, N-1$$ Здесь, в отличие от преобразования
  Фурье, размер анализируемого фрагмента и размер оконной функции зависят от
  номера соответствующей частотной компоненты $f_n$. В свою очередь, $f_n$ можно
  выбрать таким образом, что каждой ступени звукоряда будет соответствовать
  одинаковое число частотных компонент (одна или более). Пусть $N_0$ --
  количество компонент в одной октаве, а $f_{min}$ -- частота наименьшей из
  анализируемых компонент. Тогда частота $n$-й компоненты задается формулой
  $f_n = 2^{n/N_0} f_{min}$. Точно так же задаются частоты для ступеней
  звукоряда при использовании равномерно темперированного строя, поэтому
  параметр $f_{min}$ напрямую связан с частотой настройки музыкальных
  инструментов. Отношение $\frac{f_n}{f_{n+1} - f_n} = \frac{1}{2^{1/N_0}-1} =
  Q$ называется коэффициентом качества. При таком выборе частот $Q$ не зависит
  от $k$. Отсюда происходит название constant-Q преобразования.
  
  Достоинством этого преобразования является легкость дальнейшей работы со
  спектром, поскольку его компоненты напрямую соответствуют ступеням звукоряда.
  Недостатками являются большая сложность вычислений и зависимость от
  правильного определения частоты настройки. Более быстрый алгоритм вычисления
  преобразования постоянного качества, использующий результат быстрого
  преобразования Фурье исходного сигнала, был предложен в \cite{Brown1992}.
  Преобразование постоянного качества используется в \cite{Bello2005},
  \cite{Lee2006}, \cite{Mauch2008}, \cite{Mauch2009}, \cite{Oudre2009},
  \cite{Reed2009}, \cite{Cho2010}, \cite{Cho2011}, \cite{Ni2011}.
  
  \item Гребёнка фильтров (filter bank). В цифровой обработке сигналов любое
  преобразование сигнала называют фильтром. Известно (см. \cite{Rabiner1978}, с.
  424-425), что быстрое преобразование Фурье эквивалентно вполне определенной
  гребёнке достаточно грубых фильтров. Вместо них можно использовать любые
  другие фильтры, у каждого из которых центр полосы пропускания соответствует
  частоте одной из ступеней звукоряда, а ширина полосы пропускания достаточно
  мала, чтобы не охватывать частоты соседних ступеней. Эти фильтры можно
  подобрать так, чтобы они были менее грубыми, то есть более точно определяли
  количество звуковой энергии, приходящейся на их полосы пропускания. Также
  можно выбирать полосы пропускания фильтров в соответствии с частотами ступеней
  звукоряда. Недостатком данного метода является большая вычислительная
  сложность в сравнении с алгоритмом быстрого преобразования Фурье. Гребёнки
  фильтров используются в \cite{Jiang2011}, \cite{Humphrey2012}.
\end{enumerate}

Независимо от способа получения спектра, он подвергается дальнейшей обработке и
в конце концов преобразуется в имеющий меньшую размерность вектор признаков.

\section{Векторы признаков} \label{sectL_feat}

Переход от столбцов спектрограммы к векторам признаков основан на том, что
человек воспринимает звуки с частотами, отличающимися на октаву, как похожие.
Эта же особенность используется композиторами, когда инструменты, звучащие в
разных частотных полосах, воспроизводят одну и ту же ноту в разных октавах, или
несколько голосов из разных октав составляют один аккорд. Поэтому вполне
естественно просуммировать в каждом столбце спектрограммы компоненты,
соответствующие одному и тому же звуку в разных октавах. Пусть спектрограмма
была получена в результате преобразования постоянного качества, и $N_0$ --
количество частотных компонент в одной октаве в столбце $C_m$, что
соответствует шагу в $N_0/12$ полутонов. Ко всем значениям $C_m[n], ~ 0 \leq n <
N_0$, прибавляются значения $C_m[n+N_0], C_m[n+2N_0], C_m[n+3N_0], \ldots$ для
каждого $0 \leq m \leq M-1$. В результате из последовательности столбцов
$\{C_i\}_{m=0}^{M-1}$ получается последовательность $N_0$-мерных векторов
$\{B_m\}_{m=0}^{M-1}$.

Если при получении спектрограммы использовалось быстрое преобразование Фурье с
размером фрагмента $J$ отсчётов, то необходимо сопоставить компоненты спектра
частотам звукоряда (ПРОВЕРИТЬ):
\begin{equation}
C_m[n] = \sum_{k: p[k]=n} ||X_m[k]||^2 \label{fft_wrap}
\end{equation}
$$p[k] = \left(round \left[ N_0~\log_2 \left( \frac{k}{J} \cdot \frac{\nu}{f_0}
\right) \right] \right) \mod N_0$$
Эта формула применима и для спектрограммы, полученной преобразованием
постоянного качества.

Векторы признаков, полученные путём объединения спектральной информации по всем
октавам, носят общее название векторов хроматических признаков или
\emph{хроматических векторов}. Впервые такой процесс был предложен в
\cite{Fujishima1999}, а соответствующие признаки получили название
\emph{профиль тональных классов} (pitch class profile). Под \emph{тональным
классом} здесь понимается совокупность звуков, имеющих одно название, но
находящихся в разных октавах, например, все звуки \emph{до}.

В отличие от столбцов исходной спектрограммы, каждый хроматический вектор имеет
всего 12 компонент, а значит, соответствующая задача классификации решается в
пространстве меньшей размерности. Каждая из координатных осей в этом
пространстве соответствует уровню энергии, приходящемуся на один тональный
класс. Недостатками такого преобразования является потеря информации об октавах
исходных звуков (влекущая потерю информации об обращении аккорда) и наложение
шумовых компонент спектра на полезные. Несмотря на это, хроматические векторы
используются в большинстве существующих алгоритмов распознавания аккордов.

Для определения обращения аккорда анализируют низкочастотную область спектра,
что позволяет определить басовую ноту, по которой, в свою очередь, определяется
обращение аккорда. В \cite{Mauch2008}, \cite{Mauch2009}, \cite{Khadkevich2011},
\cite{Ni2011}, \cite{DeHaas2012}, \cite{Chen2012} строятся отдельные
спектрограммы для низкочастотной и высокочастотной областей спектра, граница
между которыми обычно пролегает в диапазоне от 200 Гц до 250 Гц.
Соответственно, получается два набора хроматических векторов, используемых в
дальнейшем анализе. 

Для отделения полезных компонент спектра от шумовых было предложено множество
дополнительных преобразований. Полученные путём этих преобразований признаки
также являются хроматическими.

В \cite{Lee2006} было предложено для случая спектрограммы, полученной быстрым
преобразованием Фурье, перед вычислением (\ref{fft_wrap}) заменять каждое
значение $X_m[n]$ на $\prod_{k=0}^{N_{harm}} |X[2^k \cdot n]|$, где $N_{harm}$
-- параметр, регулирующий количество гармоник. Это позволяет учесть информацию о
гармониках инструментов с определённой высотой звучания в векторе признаков,
который был назван \emph{расширенный профиль тональных классов} (enhanced pitch
class profile).

В \cite{Gomez2006} было предложено для случая спектрограммы, полученной быстрым
преобразованием Фурье, учитывать только спектральные пики (локальные максимуы в
каждом столбце). Каждый из них учитывался при вычислении не одного, а
нескольких компонентов вектора, с разными весами, в зависимости от разницы
между частотой пика и частотой ступени звукоряда. Кроме того, чтобы учесть
наличие гармоник, каждый пик с частотой $f_n$ прибавлялся к пикам с частотами
$f_n, f_n/2, f_n/3, \ldots$ с соответствующими весами. Такой вектор признаков
получил название \emph{гармонический профиль тональных классов} (harmonic
pitch class profile).

В \cite{Weller2009} и \cite{Khadkevich2011} были предложены способы
перераспределения звуковой энергии в пределах спектрограммы, полученной быстрым
преобразованием Фурье, от участков с меньшим количеством энергии к участкам с
большим количеством энергии (эта техника была предложена в \cite{Kodera1978}). В
\cite{Weller2009} допускается только перемещение энергии в пределах одного
стоблца спектрограммы, в \cite{Khadkevich2011} допускается таже перемещение
энергии между столбцами. В полученных таким образом спектрограммах более чётко
выделены горизонтальные участки с большим количеством звуковой энергии,
соответствующие инструментам с определённой высотой звучания и их гармоникам.

В \cite{Mauch2010} каждый столбец $X_m$ спектрограммы, полученной быстрым
преобразованием Фурье, преобразуется аналогично (\ref{fft_wrap}) в вектор $C'_m$
из 256 компонент, расположенных с шагом в $1/3$ полутона, что соответствует
охвату в чуть более, чем 7 октав. После этого для 84 ступеней звукоряда от
\emph{ля} субконтроктавы (27.5 Гц) до \emph{фа} третьей октавы (3322 Гц)
генерируются шаблонные 256-компонентные векторы-столбцы. В каждом из них
элементы, соответствующие ступени звукоряда и её гармоникам, задаются как
$h^{k-1}$, где $h=0.6$, а $k$ -- номер гармоники; остальные элементы равны 0.
Взятые вместе, они образуют матрицу $E$. Далее линейным методом наименьших
квадратов находится вектор $C_m$, минимизирующий $||C'_m - EC_m||$, при условии,
что все компоненты $C_m$ неотрицательны. Полученные векторы $C_m$ образуют новую
спектрограмму с шагом по частоте в $1/3$ полутона, которая обрабатывается как
если бы она была получена в результате преобразования постоянного качества.
Полученный в результате хроматический вектор признаков получил название
\emph{NNLS chroma} (Non-Negative Least Squares chroma).

Мощность звука определяется как энергия, передаваемая звуковой волной через
рассматриваемую поверхность в единицу времени. Спектр мощности звука показывает
изменение его мощности с течением времени. Он может быть получен из частотного
спектра путем возведения в квадрат каждой из его компонент. Как показано в
\cite{Fletcher1933}, воспринимаемая громкость звука приблизительно
пропорциональна десятичному логарифму уровня мощности звука (sound power
level). Поэтому имеет смысл перед преобразованием спектрограммы в
последовательность хроматических векторов заменить каждое её значение $C_m[n]$
на $\log (\eta \cdot C_m[n] + 1)$, где $\eta$ -- положительная константа,
которая обычно выбирается из диапазона $100 \leq \eta \leq 10000$. Тогда
соотношение между разными компонентами спектрограммы будет приблизительно
соответствовать соотношению между воспринимаемыми человеком уровнями громкости
соответствующих частот. Полученные таким образом признаки называют
\emph{chroma-log-pitch} (CLP) \cite{Jiang2011}.

В \cite{Mueller2009} было предложено после логарифмирования элементов
спектрограммы для каждого столбца $C_m$ вычислять дискретное косинусное
преобразование, занулять первые $\xi$ полученных коэффициентов, после чего
выполнять обратное дискретное косинусное преобразование. Если представлять
спектр звука как функцию интенсивности звука от частоты, данное преобразование
удаляет низкочастотные компоненты в спектре этой функции, т.е. длинные
последовательности отличных от нуля значений, незначительно отличающихся друг от
друга. Похожие действия выполняются при вычислении мел-частотных кепстральных
коэффициентов \cite{Logan2000}, широко используемых в распознавании речи. Из
полученной спектрограммы обычным образом вычисляются хроматические векторы. Они
получили название \emph{chroma DCT-reduced log pitch} (CRP). Целью этого
преобразования является повышение устойчивости хроматических векторов к
изменению тембра музыкальных инструментов, прежде всего для сопоставления
различных музыкальных записей. Но CRP-признаки были успешно применены к
распознаванию аккордов в \cite{Cho2011}.

В \cite{Ni2011} было предложено наряду с зависимостью человеческого восприятия
громкости от звуковой мощности учитывать зависимость от частоты звука. Для этого
на каждом фрагменте звукозаписи вместо частотного спектра вычисляется спектр
мощности, от каждой его компоненты вычисляется десятичный логарифм, после чего к
каждой компоненте применяется A-взвешивание \cite{TalbotSmith1999}.

В \cite{Mueller2007} были предложены преобразования последовательности
хроматических векторов, направленные на повышение устойчивости к шумам.
В последовательности полученных обычным способом хроматических векторов каждый
вектор $B_m$ заменяется на $B_m/||B_m||_1$, где $||B_m||_1 = \sum_{n=0}^{N_0-1}
|B_m[n]|$. Затем производится квантование значений $B_m[n],~0 \leq B_m[n] \leq
1$ с порогами, величины которых расположены логарифмически. Далее вычисляется
свёртка последовательности $\{B_m\}_{m=0}^{M-1}$ с окном Ханна длины $w \in
\mathbb{N}$, а затем прореживание полученной последовательности по основанию
$d$. Полученные в результате этих преобразований векторы признаков получили
название \emph{chroma energy normalized statictics} ($CENS_d^w$).

В \cite{Harte2006} были предложены особые признаки, не являющиеся
хроматическими. Они являются векторами в пространстве \emph{Tonnetz}
\cite{Cohn1998}, \cite{Chew2000}, моделирующем взаимоотношения между ступенями
равномерно темперированного строя. Согласно \cite{Harte2006}, в случае
равномерно темперированного строя это 6-мерное пространство. Для удобства
векторы в этом пространстве нормируют так, чтобы они попадали внутрь 6-мерного
эллипса с радиусами $(r_1, r_1, r_2, r_2, r_3, r_3)$. Координаты можно разделить
попарно на 3 круга. Первый из них в некотором роде соответствует квинтовому
кругу. В нём точки, соответствующие ступеням звукоряда, расположены на
окружности радиуса $r_1$ с шагом $5\pi / 6$. Во втором круге эти точки
расположены на окружности радиуса $r_2$ с шагом $\pi/4$, а в третьем -- на
окружности радиуса $r_3$ с шагом $\pi/3$. Их можно мыслить как круги малых и
больших терций соответственно. Точка, соответствующая аккорду, имеет координаты,
равные среднему арифметическому координат составляющих его нот. Любой
хроматический вектор может быть легко преобразован в вектор в этом пространстве.
Такие векторы признаков были использованы в \cite{Lee2007}, \cite{Lee2008},
\cite{Chen2012}, \cite{Humphrey2012}.

Сравнение качества работы некоторых из описанных типов признаков в приложении к
задаче распознавания аккордов было проведено в \cite{Jiang2011}. Наилучшие
результаты были получены с использованием признаков CRP. Авторы отмечают, что
логарифмическое преобразование спектра, применяемое при вычислении признаков CLP
и CRP, является важным шагом к повышению качества распознавания аккордов.

Принципиально другой подход к получению вектора признаков был предложен в
\cite{Humphrey2012}. Описанные выше 6-мерные признаки получаются из
спектрограммы путём применения свёрточной нейронной сети \cite{LeCun1998}. При
этом не применяются никакие знания о свойствах спектра или музыки.
Предполагается, что нейронная сеть сама определит наиболее характерные свойства
в процессе обучения.

На соревнованиях MIREX Audio Chord Estimation алгоритмы, использующие
современные признаки (\cite{Khadkevich2011}, \cite{Mauch2010},
\cite{Mueller2009}) показывают близкие результаты. Но на результат в
значительной степени влияет используемый в алгоритме метод классификации
векторов признаков.

\section{Классификация векторов признаков} \label{sectL_post}

На этом этапе находится решение задачи распознавания аккордов в звукозаписи:
полученная на предыдущем этапе последовательность векторов признаков
преобразуется в последовательность аккордов с указанием моментов начала и конца
их звучания. Перед вычислением спектрограммы звукозапись была поделена на
фрагменты, моменты начала и конца которых известны. Поэтому считается, что
каждый из полученных векторов признаков соответствует промежутку времени между
началами текущего и следующего фрагментов.

Для определения звучащего на данном фрагменте аккорда по вектору признаков
необходимо классифицировать этот вектор. В рамках задачи MIREX Audio Chord
Estimation 2012 выделялись 25 возможных классов: по одному классу для каждого
мажорного и минорного аккордов, а также один класс для отсутствия аккорда.
Многие алгоритмы также ограничиваются этим набором (\cite{Bello2005},
\cite{Lee2006}, \cite{Khadkevich2009}, \cite{Oudre2009}, \cite{Weller2009},
\cite{Cho2010}, \cite{Rocher2010}, \cite{Cho2011}, \cite{Jiang2011},
\cite{Ni2011}, \cite{Chen2012}, \cite{Humphrey2012}). В некоторых работах
выделяют также отдельные классы для доминантсептаккордов (\cite{Sheh2003},
\cite{Mauch2008}, \cite{Zhang2008}, \cite{Mauch2009}, \cite{Mauch2010},
\cite{DeHaas2012}), других септаккордов (\cite{Sheh2003}, \cite{Mauch2010}),
уменьшенных и увеличенных (\cite{Sheh2003}, \cite{Burgoyne2007},
\cite{Lee2008}, \cite{Mauch2008}, \cite{Sumi2008}, \cite{Mauch2009},
\cite{Mauch2010}, \cite{Ni2012}) и других видов аккордов.

\subsection{Метод ближайшего соседа}

Наиболее простой способ классификации -- определение расстояния от вектора
признаков до <<идеальных>> шаблонных векторов той же размерности,
соответствующих аккордам. В качестве результата выбирается аккорд, расстояние до
шаблона которого является наименьшим. Фактически, это метод $k$ ближайших
соседей для $k=1$. Такой подход был применён в \cite{Lee2006}, \cite{Oudre2009},
в одном из вариантов \cite{Jiang2011}. Мерой расстояния может выступать
косинусное расстояние, евклидово расстояние, расхождение Кульбака-Лейблера и
другие. Их сравнение было проведено в \cite{Oudre2009}. В качестве шаблона
аккордов часто используют вектор, у которого на позициях, соответствующих
входящим в аккорд нотам, стоят 1, а на остальных -- 0. Например, шаблон для
аккорда до-минор имеет вид $(1,0,0,1,0,0,0,1,0,0,0,0)$ (при условии, что первая
компонента вектора соответствует звуку \emph{до}).

Важным достоинством такого способа классификации является отсутствие этапа
обучения. Отсюда следует лёгкость добавления новых типов распознаваемых
аккордов: для этого требуется всего лишь добавить новые шаблоны. Недостатком
является невозможность учесть зависимость между подряд идущими фрагментами
звукозаписи.

Иногда (например, в \cite{Oudre2009}) в шаблоны также включают информацию о
гармонических обертонах входящих в аккорд нот. Ноты, соответствующие частотам
гармонических обертонов, могут быть получены из формулы (\ref{eq:fton}). Вклад
обертона в соответствующую компоненту шаблона определялся в \cite{Gomez2006} как
\begin{equation} \label{eq:templates_harmonics}
w_{harm}(k) = h^{k-1}
\end{equation}
где $k$ -- номер обертона, а $h < 1$ -- параметр. Соответствующий шаблонный
вектор будет иметь компоненты со значениями, отличными от 0 и 1.

Для повышения устойчивости к шумам к последовательности векторов признаков
можно предварительно применить скользящий медианный фильтр или фильтр
скользящего среднего, как в \cite{Lee2006}, \cite{Oudre2009}. 

В \cite{Mauch2009} было предложено учитывать структуру композиции перед
определением аккордов. Структура может быть задана заранее или определена
автоматически. Последовательности хроматических векторов, соответствующие
одинаковым структурным сегментам, усреднялись перед распознаванием аккордов. Эта
идея была продолжена в \cite{Cho2011}, где было предложено использовать метод
рекуррентного анализа для нахождения похожих друг на друга последовательностей
хроматических векторов и их взаимного сглаживания.

\subsection{Скрытые марковские модели и байесовские сети}

Широко используемые в методах распознавания речи \emph{скрытые марковские
модели} (СММ) \cite{Rabiner1989} также нашли применение в алгоритмах
распознавания аккордов. В отличие от метода ближайшего соседа, они позволяют в
явном виде моделировать вероятность перехода между двумя заданными аккордами.
Дадим формальное определение элементов СММ.

\begin{itemize}

\item Набор состояний модели $Q = \{Q_1, Q_2, \ldots , Q_{N_{states}}\}$. За
$q_t$ будем обозначать состояние модели в момент времени $t$.

\item Множество наблюдаемых символов $\Lambda = \{\lambda_1, \lambda_2, ...,
\lambda_{M_{symbols}}\}$.

\item Матрица переходных вероятностей $\Omega = \{\omega_{ij}\}$, где
$\omega_{ij} = P(q_t = Q_j | q_{t-1} = Q_i), \! 1 \leq i,j \leq N_{states}$.
Если любое состояние достижимо из любого, то все $\omega_{ij}$ неотрицательны.
Для всех $i,~1 \leq i \leq {N_{states}}$ верно $\sum_{j=1}^{N_{states}}
\omega_{ij} = 1$

\item Распределение вероятностей появления наблюдаемых символов в состоянии
$Q_j$, $V=\{v_j(k)\}$, где $v_j(k) = P\{\lambda_k \: at \: t|q_t = S_j\}$ при $1
\leq j \leq N_{states}, \: 1 \leq k \leq M_{symbols}$.

\item Начальное распределение вероятностей состояний $\pi =
\{\pi_i\}$, где $\pi_i = P\{q_t = Q_i\}, \: 1 \leq i \leq N_{states}$.

\end{itemize}

Состояния СММ ненаблюдаемы, в каждый момент времени доступен для наблюдения
только какой-либо символ из множества $\Lambda$. Важным свойством СММ является
то, что вероятность перехода из состояния $Q_i$ в состояние $Q_j$ не зависит от
предыдущих состояний модели.

Набор состояний СММ фиксируется заранее. В качестве наблюдаемых символов обычно
выступают векторы признаков. Матрица переходных вероятностей, параметры
распределения вероятностей появления наблюдаемых символов и параметры начального
распределения вероятностей состояний могут как задаваться изначально (как в
\cite{Bello2005}, в одном из вариантов \cite{Papadopoulos2007}, в нескольких
вариантах \cite{Cho2010}), так и определяться в результате обучения СММ (как в
\cite{Burgoyne2007}, в нескольких вариантах \cite{Papadopoulos2007},
 \cite{Mauch2008}, \cite{Khadkevich2009}, \cite{Reed2009}, в одном из вариантов
\cite{Cho2010}, \cite{Jiang2011}, \cite{Khadkevich2011}, \cite{Ni2011}).
Вероятности появления наблюдаемых символов обычно моделируются одним многомерным
нормальным распределением (как в \cite{Sheh2003}, \cite{Bello2005},
\cite{Papadopoulos2007}, \cite{Ni2011}, \cite{Chen2012}) или смесью многомерных
нормальных распределений (как в \cite{Burgoyne2007}, \cite{Khadkevich2009},
\cite{Reed2009}, \cite{Cho2010}, \cite{Khadkevich2011}). При обучении обычно
используется итеративный метод математического ожидания -- модификации
(expectation-modification), также называемый методом Баума-Уэлша или методом
прямого-обратного хода. В \cite{Reed2009} минимизируется ошибка классификации,
параметры модели обновляются при помощи градиентного спуска. При распознавании
наиболее вероятной последовательности скрытых состояний применяется алгоритм
Витерби. Стоит отметить, что иногда алгоритм Витерби применяют, не вводя явно
СММ, а задавая псевдовероятности вместо необходимых в алгоритме распределений
вероятностей (например, в \cite{Cho2011}, \cite{Humphrey2012}).

Несмотря на свою популярность, СММ не свободны от недостатков, ограничивающих
возможность их применения. Основными из них являются очень большое количество
параметров и марковское свойство, позволяющее учитывать зависимость состояния на
данном шаге от состояния только на предыдущем шаге.

Обычно наблюдаемыми символами СММ являются хроматические векторы.
Соответственно, вероятности появления наблюдаемых символов моделируются
многомерными распределениями с числом измерений, равным размерности
хроматического вектора. Оценим число параметров для типичного случая. Пусть СММ
имеет $N_{states} = 25$ состояний, каждому из которых соответствует одно
12-мерное нормальное распределение, а начальное распределение вероятностей
состояний равномерно. Тогда имеется $25 \cdot 24 = 600$ элементов в матрице
переходных вероятностей, а также как минимум 24 параметра на каждое из 25
состояний (в предположении, что матрицы ковариации многомерных нормальных
распределений диагональны). С использованием смеси нормальных распределений
вместо одного распределения количество параметров для каждого состояния
увеличивается пропорционально числу компонентов смеси.

Для уменьшения количества настраиваемых параметров часто предполагают, что
параметры для разных состояний в некотором смысле схожи, а потому могут быть
скорректированы после первоначального обучения. В хроматическом векторе каждая
компонента соответствует одному классу звуков, например, всем звукам \emph{до}.
Если его первую компоненту такого вектора, соответствущую классу звуков
\emph{до}, переставить в конец, то полученный вектор останется хроматическим,
но его первая компонента будет соответствовать классу звуков \emph{до-диез}.
Аналогичные циклические перестановки возможны для математических ожиданий и
матрицы ковариации соответствующего многомерного распределения.

Так, если в векторе математических ожиданий для распределения, соответствующего
аккорду \emph{до-диез-мажор}, переставить одну компоненту из начала в конец, то
полученный вектор математических ожиданий будет соответствовать аккорду
\emph{до-мажор}. Такими сдвигами можно привести все векторы матожиданий для
распределений, соответствующих мажорным аккордам, к виду, в котором компонента,
соответствующая основному звуку аккорда, будет первой. После этого можно
усреднить все математические ожидания по всем аккордам, и обратными сдвигами
вернуть усреднённые векторы матожиданий на свои места. Аналогично можно
усреднить матрицы ковариации для всех аккордов одного типа. Также возможно
усреднение компонентов матрицы переходов для случаев переходов между аккордами
соответствующих типов, основные звуки которых отстоят на одинаковое число
полутонов. Процедура усреднения применяется, например, в \cite{Sheh2003},
\cite{Papadopoulos2007}, \cite{Cho2010}, \cite{Khadkevich2011}. Усреднение
параметров модели полезно в случае недостатка обучающих данных или их
неравномерного распределения по рассматриваемому набору аккордов.

Моделирование зависимости текущего состояния модели только от состояния на
предыдущем шаге приводит к заметной проблеме. Очевидно, что смена аккорда
производится не при каждой смене звукового фрагмента. Поэтому необходимо
контролировать длительность нахождения модели в одном состоянии. В случае СММ
первого типа это можно сделать, регулируя значения на главной диагонали
матрицы переходов. А в \cite{Chen2012} в СММ было дополнительно введено
распределение, задающее вероятность нахождения модели в состоянии $Q_i$ в
течение $d$ фрагментов, где $d \leq 20$. Процедура обучения и алгоритм Витерби
были соответствующим образом модифицированы.

Другой подход к моделированию длительности нахождения СММ в одном состоянии --
построение отдельной модели для каждого аккорда и связывание этих моделей в
одну СММ с общими входом и выходом для каждой из моделей. Он применялся в одном
из вариантов \cite{Burgoyne2007}, \cite{Mauch2008}, \cite{Khadkevich2009},
\cite{Khadkevich2011}. В этом случае можно регулировать параметры моделей
каждого отдельного аккорда (как в \cite{Mauch2008}), а также добавлять штраф за
переход от модели одного аккорда к модели другого аккорда (как в
\cite{Khadkevich2009}, \cite{Khadkevich2011}).

Были предложены различные способы для учёта информации о предыдущих состояниях
модели в том числе через введение понятий жанра и тональности. В
\cite{Khadkevich2009} использовалась языковая модель, которая позволяет
учитывать более чем одно предыдущее состояние СММ. В \cite{Lee2007} было
предложено строить 24 СММ, по одной для каждой из мажорных и минорных
тональностей. При распознавании аккордов для каждой модели определялась наиболее
вероятная последовательность состояний. В качестве результата выбиралась та из
последовательностей, вероятность которой была наибольшей. Дополнительным
результатом при этом было определение тональности композиции. В \cite{Lee2008}
аналогичным образом строились отдельные СММ для 6 различных музыкальных жанров.
В \cite{Ni2012} отдельные СММ строились для 11 различных жанров, но при этом они
были объединены в одну гипер-жанровую модель с более сложной процедурой
обучения. Несмотря на большой потенциал такого рода комбинаций, они требуют
существенно больше обучающих данных. В случае \cite{Lee2007} и \cite{Lee2008}
использовались звукозаписи, сгенерированные из MIDI-файлов. В \cite{Ni2012}
исползовался достаточно большой набор реальных музыкальных звукозаписей.
Тональность может быть явным образом введена в саму СММ наряду с басовой нотой.
Предложенная в \cite{Ni2011} СММ включала в себя в том числе 12 скрытых
состояний для текущей басовой ноты и 24 скрытых состояний для текущей
тональности. При этом общее количество комбинаций скрытых состояний становится
слишком большим, поэтому приходится накладывать дополнительные ограничения на
допустимые переходы между аккордами и между тональностями и на допустимые
сочетания аккордов и басовых нот.

В \cite{Mauch2010} было предложено использовать динамическую байесовскую сеть,
которая, по сути, является обобщением СММ (см. \cite{Ghahramani2001}). В ней
используются скрытые состояния для текущих метрической позиции, тональности,
аккорда и басовой ноты; наблюдениями являются 2 вектора хроматических признаков:
для высоких и для низких частот. Такая модель позволяет моделировать сложные
музыкальные взаимоотношения. С другой стороны, она имеет множество параметров, и
поэтому требует большего количества обучающих данных. Для получения наиболее
вероятной последовательности в такой сети можно использовать модификацию
алгоритма Витерби, но из-за размеров сети этот процесс оказывается более
длительным, чем в случае СММ.

\subsection{Другие модели}

В \cite{Weller2009} было предложено использовать более сильный алгоритм
классификации, чем метод ближайшего соседа, основанный на методе опорных
векторов. Помимо текущего вектора признаков этот алгоритм позволяет учитывать
также признаки на предыдущем или на следующем фрагменте звукозаписи, а также
попарные произведения компонент вектора признаков.

В одном из вариантов \cite{Burgoyne2007} было предложено заменить СММ на
условное случайное поле \cite{Lafferty2001}. Оно определяется следующим образом.
Обозначим за $\boldsymbol{X}$ и $\boldsymbol{Y}$ множество наблюдений и
множество случайных переменных соответственно. Пусть $G = (V, E)$ -- такой граф,
что $\boldsymbol{Y} = (\boldsymbol{Y}_v)_{v \in V}$, то есть $\boldsymbol{Y}$
можно проиндексировать вершинами этого графа. Тогда $(\boldsymbol{X},
\boldsymbol{Y})$ называется \emph{условным случайным полем}, если случайные
переменные $\boldsymbol{Y}_v$ при условии $\boldsymbol{X}$ удовлетворяют
марковскому свойству с учётом графа: $p(\boldsymbol{Y}_v | \boldsymbol{X},
\boldsymbol{Y}_w, w \sim v) = p(\boldsymbol{Y}_v | \boldsymbol{X},
\boldsymbol{Y}_w, w \sim v)$, где $w \sim v$ означает, что $w$ и $v$ являются
соседями в графе $G$. В случае, когда $G$ является цепью или деревом, к
соответствующему условному случайному полю можно применять алгоритмы,
аналогичные методу прямого-обратного хода и алгоритму Витерби. В отличие от СММ,
при определении наиболее вероятной последовательности вершин графа
максимизируется не $p(\boldsymbol{X}, \boldsymbol{Y})$, а $p(\boldsymbol{Y} |
\boldsymbol{X})$. Кроме того, в такой модели каждое скрытое состояние зависит не
только от текущего наблюдения, но от всей предыдущей последовательности
наблюдений. В \cite{Burgoyne2007} отмечается, что условное случайное поле
обучается существенно дольше, чем СММ.

В \cite{DeHaas2012} была предложена полноценная модель гармонии, построенная на
основе музыкально-теоретических соотношений между аккордами. Её применение
требует знания тональности, поэтому для звукозаписи предварительно определяется
последовательность тональностей с ограничением на минимальную длину фрагмента в
одной тональности в 16 метрических долей. На каждом фрагменте звука определяется
набор наиболее вероятных аккордов (вычисляются расстояния от хроматического
вектора до шаблонов аккордов), после чего модель гармонии используется для
определения наиболее вероятной последовательности аккордов с учётом уже
определённых аккордов на всех предыдущих фрагментах.

В \cite{Yoshioka2004} использовался собственный алгоритм для определения
вероятности гипотез. Каждая гипотеза состоит из последовательности аккордов,
определённой до данного фрагмента, и тональности. На каждом фрагменте
определяется вероятность гипотез со всеми возможными вариантами текущего
аккорда. В формуле для вычисления вероятности гипотезы учитываются тональность,
вероятность смены аккорда, хроматический вектор, басовый звук, сочетаемость
аккорда и басового звука. Очень похожий подход с другими формулами для
определения вероятности гипотез был применён в \cite{Sumi2008}.

Подход, в чём-то похожий на алгоритм Витерби, был предложен в \cite{Rocher2010}.
Здесь на каждом фрагменте определяется набор наиболее вероятных аккордов
(вычисляются расстояния от хроматического вектора до шаблонов аккордов) и
тональностей (вычисляются расстояния от хроматического вектора до шаблонных
векторов тональностей из \cite{Temperley2001}). Затем все наиболее вероятные
кандидаты объединяются в пары. Расстояние между парами (аккорд, тональность)
определяется в соответствии с \cite{Lerdahl2001} на основе взаимоотношений
между звуками, составляющими аккорды, и звуками, входящими в тональности. Тогда
методом динамического программирования можно определить последовательность пар
(аккорд, тональность) по всем фрагментам, имеющую наименьшую сумму расстояний
между соседними парами.

% \section{Распознавание аккордов с использованием дополнительной информации}
% \label{sectL_recconstr}
% 
% \cite{Zhang2008}, \cite{Mcvicar2011}, \cite{Hrybyk2010}

\section{Выводы}

\begin{enumerate}
  \item В большинстве современных алгоритмов для распознавания аккордов
  используются методы определения ритма; методы определения частоты настройки
  музыкальных инструментов применяются реже.
  \item Среди множества типов хроматических признаков наилучшее качество
  распознавания достигается при помощи тех из них, алгоритмы вычисления которых
  обеспечивают подавление шумовых спектральных компонент.
  \item Скрытые марковские модели и динамические байесовские сети являются
  наиболее популярными методами классификации в алгоритмах распознавания
  аккордов. Эти методы позволяют добиться наилучшего качества распознавания, но
  требуют настройки очень большого количества параметров в процессе обучения.
\end{enumerate}

\clearpage
